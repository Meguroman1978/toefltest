# 🔧 修正内容まとめ（2025-12-14）

## ✅ 修正した問題

### 1. ❌ INSERT_TEXT問題のマーカー表示が逆になっていた

**問題**:
- 「Look at the four squares [■]」から始まる質問の時に [■] が表示されない
- それ以外の質問の時に [■] が表示される
- **完全に逆の挙動**

**原因**:
```typescript
// components/ReadingPassage.tsx (109行目)
{parseText(isInsertQuestion && !isTargetParagraph ? cleanText : text)}
```
条件が間違っていた。

**修正**:
```typescript
{parseText(!isInsertQuestion ? cleanText : text)}
```
INSERT問題**ではない**場合にマーカーを削除するように修正。

---

### 2. ❌ 語彙・熟語特訓モードでReference Textが表示される

**問題**:
- 語彙・熟語特訓モードでは、問題文自体が単語の例文なので、Reference Textは不要
- しかし、常に表示されていた

**修正**:
```typescript
// screens/ResultScreen.tsx
const isVocabLesson = passage.questions.some(q => q.categoryLabel === "語彙・熟語特訓");

// Reference Text を条件付きで表示
{!isVocabLesson && q.relevantContext && (
  <div>
    <h4>Reference Text</h4>
    <div>"{q.relevantContext}"</div>
  </div>
)}
```

---

### 3. ❌ Listeningテストの結果がalertのみで詳細が見れない

**問題**:
- Listening テスト完了後、`alert()` でスコアを表示するだけ
- 詳細な解説や間違えた問題の確認ができない

**修正**:
- ListeningSetをPassage形式に変換
- ResultScreenを使用して詳細な結果表示
- 学習履歴にも保存

```typescript
// App.tsx - finishListeningTest()
const listeningAsPassage: Passage = {
    id: listeningSet.id,
    title: listeningSet.title,
    paragraphs: [listeningSet.transcript],
    questions: listeningSet.questions
};
setPassage(listeningAsPassage);
setScreen('RESULT');
```

---

### 4. ❌ Writingテストで音声再生ボタンが表示されるが何も再生されない

**問題**:
- Academic Discussion タイプのWritingタスクには音声がない
- しかし、再生ボタンが表示される

**修正**:
```typescript
// screens/WritingTestScreen.tsx
{step === 'LISTENING' && task.listeningTranscript && (
  <div>
    {/* 音声再生UI */}
  </div>
)}
{step === 'LISTENING' && !task.listeningTranscript && (
  <div>
    <p>No listening component for this task.</p>
    <button onClick={handleListeningDone}>Start Writing</button>
  </div>
)}
```

---

### 5. ✨ 新機能：単語・熟語帳

**追加内容**:

#### A. VocabBookScreen コンポーネント作成
- 間違えた単語・熟語の一覧表示
- 単語ごとに以下を表示：
  - 単語/熟語
  - 正解の意味
  - 例文（relevantContext）
  - 出題された問題
  - 日付
- 個別削除ボタン
- 全削除ボタン
- フィルター（すべて/最近の20件）

#### B. 自動保存機能
ResultScreenで、間違えた語彙問題を自動的に単語帳に保存：

```typescript
// screens/ResultScreen.tsx (useEffect内)
if (!isCorrect && (q.category === 'Vocabulary' || q.categoryLabel === '語彙問題' || q.categoryLabel === '語彙・熟語特訓')) {
  const vocabBook = JSON.parse(localStorage.getItem('toefl_vocab_book') || '[]');
  
  const wordMatch = q.prompt.match(/[""](.+?)[""]|\*\*(.+?)\*\*/);
  const targetWord = wordMatch ? (wordMatch[1] || wordMatch[2]) : '';
  const correctOption = q.options.find(opt => correctAns.includes(opt.id));
  
  if (targetWord && correctOption && !exists) {
    vocabBook.push({
      word: targetWord,
      definition: correctOption.text,
      example: q.relevantContext || '',
      question: q.prompt,
      date: new Date().toISOString()
    });
    localStorage.setItem('toefl_vocab_book', JSON.stringify(vocabBook));
  }
}
```

#### C. HomeScreenにボタン追加
左サイドバーに「単語・熟語帳」ボタンを追加：
- 紫色のボタン
- アイコン：📚 (fa-book)
- クリックでVocabBookScreenをモーダル表示

---

## 📊 変更されたファイル

| ファイル | 変更内容 |
|---------|---------|
| `components/ReadingPassage.tsx` | INSERT_TEXT マーカー表示ロジック修正 |
| `screens/ResultScreen.tsx` | 語彙特訓モード判定、Reference Text条件表示、単語帳自動保存 |
| `screens/WritingTestScreen.tsx` | 音声再生ボタンの条件表示 |
| `screens/VocabBookScreen.tsx` | **新規作成** - 単語帳画面 |
| `screens/HomeScreen.tsx` | 単語帳ボタン追加 |
| `App.tsx` | Listening結果表示を詳細化 |

---

## 🚀 デプロイ手順

```bash
# 1. 最新コードを取得
cd /path/to/toefltest
git pull origin main

# 2. 環境変数を設定
export GEMINI_API_KEY="あなたのAPIキー"

# 3. デプロイ
flyctl deploy --build-arg GEMINI_API_KEY=$GEMINI_API_KEY
```

---

## ✅ 動作確認チェックリスト

### INSERT_TEXT問題
- [ ] INSERT_TEXT問題で [■] マーカーが表示される
- [ ] 他の問題では [■] マーカーが表示されない
- [ ] [■] マーカーをクリックすると選択状態になる

### 語彙・熟語特訓
- [ ] 語彙・熟語特訓モードの結果画面でReference Textが表示されない
- [ ] 他のモードでは Reference Text が表示される

### Listeningテスト
- [ ] Listening完了後、詳細な結果画面が表示される
- [ ] 各問題の解説が表示される
- [ ] 学習履歴に保存される

### Writingテスト
- [ ] Integrated Writing: 音声再生ボタンが表示される
- [ ] Academic Discussion: 音声再生ボタンが表示されない

### 単語・熟語帳
- [ ] HomeScreenに「単語・熟語帳」ボタンが表示される
- [ ] ボタンをクリックすると単語帳が開く
- [ ] 語彙問題で間違えると自動的に保存される
- [ ] 単語ごとに削除ボタンが機能する
- [ ] 「すべて削除」ボタンが機能する

---

## 🎓 使い方

### 単語・熟語帳の使い方

1. **自動保存**:
   - Reading テストまたは語彙・熟語特訓で間違えた単語が自動保存される
   - 同じ単語は重複保存されない

2. **単語帳を開く**:
   - HomeScreenの左サイドバー「単語・熟語帳」をクリック

3. **単語を確認**:
   - 単語、意味、例文、出題された問題を確認
   - フィルター機能で「最近の20件」だけ表示可能

4. **単語を削除**:
   - 覚えた単語は個別に削除できる
   - 「すべて削除」で一括削除も可能

---

## 📝 技術的な詳細

### LocalStorage使用

```typescript
// 単語帳データの構造
interface VocabItem {
  word: string;           // 単語
  definition: string;     // 正解の意味
  example: string;        // 例文
  question: string;       // 出題された問題
  date: string;          // 保存日時（ISO 8601）
}

// LocalStorageキー
// toefl_vocab_book: VocabItem[]
```

### 単語抽出ロジック

```typescript
// 問題文から単語を抽出
const wordMatch = q.prompt.match(/[""](.+?)[""]|\*\*(.+?)\*\*/);
```

このロジックで以下の形式に対応：
- `"word"` (ダブルクォート)
- `**word**` (マークダウン太字)

---

## 🐛 既知の問題・今後の改善案

### 現在の制限事項

1. **単語抽出の精度**:
   - 問題文の形式によっては単語が正しく抽出されない可能性
   - 改善案：より柔軟な正規表現、または問題生成時にメタデータとして単語を含める

2. **重複チェック**:
   - 現在は単語の完全一致のみでチェック
   - 大文字小文字の違いや活用形は別の単語として扱われる

3. **エクスポート機能**:
   - 単語帳をCSVやテキストファイルとしてエクスポートする機能はまだない

### 今後の改善案

1. **復習モード**:
   - 単語帳から単語を選んで復習テストを作成
   - 間隔反復学習（SRS）の実装

2. **タグ機能**:
   - 単語にタグ付け（例：「難しい」「重要」「Biology」）
   - タグでフィルタリング

3. **音声再生**:
   - 単語の発音を聞けるようにする
   - Web Speech API または外部音声API

4. **統計情報**:
   - カテゴリー別の単語数
   - 習得率の可視化

---

## 🎉 まとめ

この更新で、以下が改善されました：

1. ✅ INSERT_TEXT問題のマーカー表示が正しく動作
2. ✅ 語彙特訓モードの結果表示が最適化
3. ✅ Listeningテストの結果が詳細に表示
4. ✅ Writingテストの音声ボタンが適切に表示
5. ✨ 単語帳機能で復習が効率化

**デプロイ後、必ずブラウザのキャッシュをクリアしてください！**
- `Ctrl+Shift+R` (Windows) / `Cmd+Shift+R` (Mac)

---

**Good luck with your TOEFL preparation! 📚🎓**
